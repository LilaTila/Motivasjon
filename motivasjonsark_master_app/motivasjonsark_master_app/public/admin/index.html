<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Master â€“ Svar</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background:#f7f7f8; color:#111; }
    header, main { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .top { display:flex; gap:12px; align-items:center; }
    input, button { padding:8px 10px; border-radius: 10px; border:1px solid #ddd; font:inherit; }
    button { background: #1b75bb; color:#fff; border:none; cursor:pointer; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: top; }
    th { text-align: left; background: #f0f5fa; }
    .card { background: white; border-radius: 12px; padding: 12px; box-shadow:0 2px 10px rgba(0,0,0,.05); }
    .muted { color: #666; }
    .answers p { margin: 0 0 10px; }
    .row { display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>ðŸ“¥ Master â€“ mottatte svar</h1>
    <div>
      <input id="token" placeholder="Admin token" style="min-width:240px" />
    </div>
  </div>
  <div class="top" style="margin-top:8px;">
    <input id="search" placeholder="SÃ¸k i metadata/svarâ€¦" />
    <button onclick="loadData()">Last</button>
    <button onclick="exportCsv()">Eksport CSV</button>
  </div>
</header>
<main>
  <div id="list" class="card"></div>
</main>

<script>
async function loadData() {
  const token = document.getElementById('token').value.trim();
  const q = document.getElementById('search').value.trim();
  const res = await fetch('/api/responses' + (q ? ('?q=' + encodeURIComponent(q)) : ''), {
    headers: { 'x-admin-token': token }
  });
  const data = await res.json();
  const list = document.getElementById('list');
  if (!res.ok || !data.ok) { list.innerHTML = '<p class="muted">Feil ved innlasting.</p>'; return; }
  list.innerHTML = renderTable(data.items);
}

function renderTable(items) {
  if (!items.length) return '<p class="muted">Ingen svar enda.</p>';
  let html = '<table><thead><tr><th>ID</th><th>Tid</th><th>Metadata</th><th>Kilde</th><th>Svar</th><th>Handling</th></tr></thead><tbody>';
  for (const r of items) {
    let answers = JSON.parse(r.answers_json);
    let pretty = Object.entries(answers).map(([q,a]) => `<p><strong>${q}</strong><br/>${String(a||'').replace(/\n/g,'<br/>')}</p>`).join('');
    html += `<tr>
      <td>${r.id}</td>
      <td>${r.created_at}</td>
      <td>${r.metadata || ''}</td>
      <td>${r.source || ''}</td>
      <td class="answers">${pretty}</td>
      <td>
        <input placeholder="videresend tilâ€¦" id="fwd-${r.id}" style="margin-bottom:6px; display:block;"/>
        <button onclick="forwardOne(${r.id})">Videresend</button>
      </td>
    </tr>`;
  }
  html += '</tbody></table>';
  return html;
}

async function exportCsv() {
  const token = document.getElementById('token').value.trim();
  const res = await fetch('/api/export.csv', { headers: { 'x-admin-token': token } });
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'responses.csv'; a.click();
}

async function forwardOne(id) {
  const token = document.getElementById('token').value.trim();
  const to = document.getElementById('fwd-' + id).value.trim();
  if (!to) return alert('Skriv inn en e-postadresse.');
  const res = await fetch('/api/responses/' + id + '/forward', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-admin-token': token },
    body: JSON.stringify({ to })
  });
  const data = await res.json();
  if (res.ok && data.ok) alert('Sendt!'); else alert('Feil: ' + (data.error||'ukjent'));
}
</script>
</body>
</html>
